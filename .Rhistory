mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id))
activity_list <- activity_list %>%
# Add missing FCDO activity IDs (IDRC and AgResults)
rename(programme_id = activity_id) %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id),
# Add Fund and Funder label
fund = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "FCDO Research - Programmes",
str_detect(programme_id, "GB-GOV-10") ~ "DHSC - Global Health Research - Partnerships",
TRUE ~ fund),
gov_funder = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "Foreign, Commonwealth and Development Office",
str_detect(programme_id, "GB-GOV-10") ~ "Department of Health and Social Care",
TRUE ~ gov_funder)) %>% unique()
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
activity_list_unnest_6 <- partner_activity_comb %>%
filter(lengths(budget_value) != 0) %>%
unnest(c(budget_status,budget_value,budget_value_currency,budget_period_start_iso_date,budget_period_end_iso_date)) %>%
select(iati_identifier,
budget_status,
budget_value,
budget_value_currency,
budget_period_start_iso_date,
budget_period_end_iso_date) %>%
unique()
# Find activities with multiple budgets for same period (i.e. indicative and committed)
multiple_budgets <- activity_list_unnest_6 %>%
select(iati_identifier, budget_status, budget_period_start_iso_date, budget_period_end_iso_date) %>%
unique() %>%
group_by(iati_identifier, budget_period_start_iso_date, budget_period_end_iso_date) %>%
summarise(count = n()) %>%
filter (count > 1)
sum(activity_list_unnest_6$budget_value)
names(activity_list_unnest_6)
unique(activity_list_unnest_6$budget_status)
aggregate(budget_value ~ budget_status, data = activity_list_unnest_6, sum())
aggregate(budget_value ~ budget_status, data = activity_list_unnest_6, sum)
sum(activity_list$amount)
activity_list_unnest_6 <- partner_activity_comb %>%
filter(lengths(budget_value) != 0) %>%
unnest(c(budget_status,budget_value,budget_value_currency,budget_period_start_iso_date,budget_period_end_iso_date)) %>%
select(iati_identifier,
budget_status,
budget_value,
budget_value_currency,
budget_period_start_iso_date,
budget_period_end_iso_date) %>%
unique()
# Find activities with multiple budgets for same period (i.e. indicative and committed)
multiple_budgets <- activity_list_unnest_6 %>%
select(iati_identifier, budget_status, budget_period_start_iso_date, budget_period_end_iso_date) %>%
unique() %>%
group_by(iati_identifier, budget_period_start_iso_date, budget_period_end_iso_date) %>%
summarise(count = n()) %>%
filter (count > 1)
# Keep only the committed budget in these cases
activity_list_unnest_6 <- activity_list_unnest_6 %>%
filter(!(iati_identifier %in% multiple_budgets$iati_identifier) |
budget_status == "2")
# Sum to get total budget per activity
activity_list_unnest_6 <- activity_list_unnest_6 %>%
group_by(iati_identifier, budget_value_currency) %>%
summarise(budget_period_start_iso_date = min(budget_period_start_iso_date),
budget_period_end_iso_date = max(budget_period_end_iso_date),
budget_value = sum(budget_value)) %>%
rename(period_start = budget_period_start_iso_date, period_end = budget_period_end_iso_date, amount = budget_value, currency = budget_value_currency)
# Extract base activity information - hierarchy and status
activity_list_base <- partner_activity_comb %>%
select(iati_identifier, hierarchy,
activity_status = activity_status_code,
gov_funder,
activity_id,
fund) %>%
unique() %>%
mutate(activity_status = str_replace(activity_status, "1", "Pipeline/identification"),
activity_status = str_replace(activity_status, "2", "Implementation"),
activity_status = str_replace(activity_status, "3", "Finalisation"),
activity_status = str_replace(activity_status, "4", "Closed"),
activity_status = str_replace(activity_status, "5", "Cancelled"),
activity_status = str_replace(activity_status, "6", "Suspended"))
nrow(activity_list_unnest_6)
View(activity_list_unnest_6)
View(multiple_budgets)
activity_list_unnest_6 <- partner_activity_comb %>%
filter(lengths(budget_value) != 0) %>%
unnest(c(budget_status,budget_value,budget_value_currency,budget_period_start_iso_date,budget_period_end_iso_date)) %>%
select(iati_identifier,
budget_status,
budget_value,
budget_value_currency,
budget_period_start_iso_date,
budget_period_end_iso_date) %>%
unique()
# Find activities with multiple budgets for same period (i.e. indicative and committed)
multiple_budgets <- activity_list_unnest_6 %>%
select(iati_identifier, budget_status, budget_period_start_iso_date, budget_period_end_iso_date) %>%
unique() %>%
group_by(iati_identifier, budget_period_start_iso_date, budget_period_end_iso_date) %>%
summarise(count = n()) %>%
filter (count > 1)
activity_list_unnest_6 <- partner_activity_comb %>%
filter(lengths(budget_value) != 0) %>%
unnest(c(budget_status,budget_value,budget_value_currency,budget_period_start_iso_date,budget_period_end_iso_date)) %>%
select(iati_identifier,
budget_status,
budget_value,
budget_value_currency,
budget_period_start_iso_date,
budget_period_end_iso_date) %>%
unique()
nrow(activity_list_unnest_6)
multiple_budgets <- activity_list_unnest_6 %>%
select(iati_identifier, budget_status, budget_period_start_iso_date, budget_period_end_iso_date) %>%
unique() %>%
group_by(iati_identifier, budget_period_start_iso_date, budget_period_end_iso_date) %>%
summarise(count = n()) %>%
filter (count > 1)
# Keep only the committed budget in these cases
activity_list_unnest_6 <- activity_list_unnest_6 %>%
filter(!(iati_identifier %in% multiple_budgets$iati_identifier) |
budget_status == "2")
nrow(activity_list_unnest_6)
# Sum to get total budget per activity
activity_list_unnest_6 <- activity_list_unnest_6 %>%
group_by(iati_identifier, budget_value_currency) %>%
summarise(budget_period_start_iso_date = min(budget_period_start_iso_date),
budget_period_end_iso_date = max(budget_period_end_iso_date),
budget_value = sum(budget_value)) %>%
rename(period_start = budget_period_start_iso_date, period_end = budget_period_end_iso_date, amount = budget_value, currency = budget_value_currency)
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7, by = "iati_identifier")
# Assign a reporting org name if missing
activity_list <- activity_list %>%
mutate(reporting_org = coalesce(reporting_org_narrative, reporting_org_ref, gov_funder))
# Reorder columns and add date of refresh
activity_list <- activity_list %>%
select(iati_identifier, reporting_org_ref, reporting_org, reporting_org_country,
hierarchy, activity_status, activity_id,
activity_title, activity_description, start_date, end_date,
recipient_country, sector_name,
partner, partner_country,
gov_funder, fund,
amount, period_start, period_end, currency) %>%
unique() %>%
mutate(refresh_date = Sys.Date())
activity_list <- activity_list %>%
# Add missing FCDO activity IDs (IDRC and AgResults)
rename(programme_id = activity_id) %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id),
# Add Fund and Funder label
fund = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "FCDO Research - Programmes",
str_detect(programme_id, "GB-GOV-10") ~ "DHSC - Global Health Research - Partnerships",
TRUE ~ fund),
gov_funder = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "Foreign, Commonwealth and Development Office",
str_detect(programme_id, "GB-GOV-10") ~ "Department of Health and Social Care",
TRUE ~ gov_funder)) %>% unique()
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang)
activity_list_unnest_1_title[activity_list_unnest_1_title$iati_identifier=="GB-COH-877338-RF15005",]
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang))
activity_list_unnest_1_title[activity_list_unnest_1_title$iati_identifier=="GB-COH-877338-RF15005",]
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
filter(title_narrative_xml_lang != "fr")
activity_list_unnest_1_title[activity_list_unnest_1_title$iati_identifier=="GB-COH-877338-RF15005",]
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang))
unique(activity_list_unnest_1_title$title_narrative_xml_lang)
# 1) Unlist activity title and description
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
filter(!title_narrative_xml_lang == "fr")
activity_list_unnest_1_title[activity_list_unnest_1_title$iati_identifier=="GB-COH-877338-RF15005",]
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = as.character(title_narrative_xml_lang))
View(activity_list_unnest_1_title)
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = as.character(title_narrative_xml_lang)) %>%
filter(!title_narrative_xml_lang == "fr")
View(activity_list_unnest_1_title)
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = as.character(title_narrative_xml_lang))
View(activity_list_unnest_1_title)
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = ifelse(is.na(title_narrative_xml_lang),"",title_narrative_xml_lang))
View(activity_list_unnest_1_title)
unique(activity_list_unnest_1_title$title_narrative_xml_lang)
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = ifelse(is.na(title_narrative_xml_lang),"",title_narrative_xml_lang)) %>%
filter(title_narrative_xml_lang != "fr")
View(activity_list_unnest_1_title)
# 1) Unlist activity title and description
activity_list_unnest_1_title <- partner_activity_comb %>%
select(iati_identifier, title_narrative, title_narrative_xml_lang) %>%
unnest(cols = c(title_narrative,title_narrative_xml_lang)) %>%
mutate(title_narrative_xml_lang = ifelse(is.na(title_narrative_xml_lang),"",title_narrative_xml_lang)) %>%
filter(title_narrative_xml_lang != "fr") %>%
select(iati_identifier, title_narrative) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(title_narrative = paste(coalesce(title_narrative, ""), collapse = "; ")) %>%
rename(activity_title = title_narrative)
activity_list_unnest_1_description <- partner_activity_comb %>%
select(iati_identifier, description_narrative, description_narrative_xml_lang) %>%
unnest(cols = c(description_narrative,description_narrative_xml_lang)) %>%
mutate(description_narrative_xml_lang = ifelse(is.na(description_narrative_xml_lang),"",description_narrative_xml_lang)) %>%
filter(description_narrative_xml_lang != "fr") %>%
select(iati_identifier, description_narrative) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(description_narrative = paste(coalesce(description_narrative, ""), collapse = "; ")) %>%
rename(activity_description = description_narrative)
activity_list_unnest_1 <- full_join(activity_list_unnest_1_title, activity_list_unnest_1_description, by = "iati_identifier")
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7, by = "iati_identifier")
# Assign a reporting org name if missing
activity_list <- activity_list %>%
mutate(reporting_org = coalesce(reporting_org_narrative, reporting_org_ref, gov_funder))
# Reorder columns and add date of refresh
activity_list <- activity_list %>%
select(iati_identifier, reporting_org_ref, reporting_org, reporting_org_country,
hierarchy, activity_status, activity_id,
activity_title, activity_description, start_date, end_date,
recipient_country, sector_name,
partner, partner_country,
gov_funder, fund,
amount, period_start, period_end, currency) %>%
unique() %>%
mutate(refresh_date = Sys.Date())
activity_list <- activity_list %>%
# Add missing FCDO activity IDs (IDRC and AgResults)
rename(programme_id = activity_id) %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id),
# Add Fund and Funder label
fund = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "FCDO Research - Programmes",
str_detect(programme_id, "GB-GOV-10") ~ "DHSC - Global Health Research - Partnerships",
TRUE ~ fund),
gov_funder = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "Foreign, Commonwealth and Development Office",
str_detect(programme_id, "GB-GOV-10") ~ "Department of Health and Social Care",
TRUE ~ gov_funder)) %>% unique()
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
activity_list_unnest_2_country <- partner_activity_comb %>%
#filter(lengths(recipient_country_code) != 0) %>%
unnest(c(recipient_country_code)) %>%
select(iati_identifier, recipient_country_code)
View(activity_list_unnest_2_country)
activity_list_unnest_2_region <- partner_activity_comb %>%
#filter(lengths(recipient_country_code) != 0) %>%
unnest(c(recipient_region_code)) %>%
select(iati_identifier, recipient_region_code)
View(activity_list_unnest_2_region)
activity_list_unnest_2_country$recipient_country <- countrycode_list$name[match(activity_list_unnest_2_country$recipient_country_code,countrycode_list$code)]
activity_list_unnest_2_region$recipient_region <- regioncode_list$name[match(activity_list_unnest_2_region$recipient_region_code,regioncode_list$code)]
activity_list_unnest_2_country <- activity_list_unnest_2_country %>% select(-recipient_country_code) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(recipient_country = paste(coalesce(recipient_country, ""), collapse = ", "))
activity_list_unnest_2_region <- activity_list_unnest_2_region %>% select(-recipient_region_code) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(recipient_region = paste(coalesce(recipient_region, ""), collapse = ", "))
activity_list_unnest_2 <- full_join(activity_list_unnest_2_country, activity_list_unnest_2_region, by = "iati_identifier")
View(activity_list_unnest_2)
activity_list_unnest_2[activity_list_unnest_2$iati_identifier=="GB-COH-03122495-A0014",]
activity_list_unnest_2$recipient_country_region <- coalesce(activity_list_unnest_2$recipient_country, activity_list_unnest_2$recipient_region)
activity_list_unnest_2[activity_list_unnest_2$iati_identifier=="GB-COH-03122495-A0014",]$recipient_country_region
activity_list_unnest_2_test <- activity_list_unnest_2 %>%
mutate(across(c(recipient_country_region), na_if, "Developing countries, unspecified")) %>%
select(-recipient_country, -recipient_region)
View(activity_list_unnest_2_test)
activity_list_unnest_2_test[activity_list_unnest_2_test$iati_identifier=="GB-COH-03122495-A0014",]$recipient_country_region
activity_list_unnest_2_test[activity_list_unnest_2_test$recipient_country_region=="Developing countries, unspecified",]
rm(activity_list_unnest_2_test)
activity_list_unnest_2 <- activity_list_unnest_2 %>%
mutate(across(c(recipient_country_region), na_if, "Developing countries, unspecified")) %>%
select(-recipient_country, -recipient_region)
activity_list_unnest_2[activity_list_unnest_2$iati_identifier=="GB-COH-03122495-A0014",]
View(transaction_org_countries_summarised)
View(transaction_orgs_summarised)
activity_list_unnest_2_trans <- full_join(activity_list_unnest_2, transaction_countries_summarised, by = "iati_identifier")
View(activity_list_unnest_2_trans)
unique(activity_list_unnest_2_trans$recipient_country)
activity_list_unnest_2_trans$recipient_country <- coalesce(activity_list_unnest_2_trans$recipient_country_region, activity_list_unnest_2_trans$recipient_country)
activity_list_unnest_2 <- activity_list_unnest_2_trans
activity_list_unnest_2[activity_list_unnest_2$recipient_country=="GB-COH-03122495-A0014",]
activity_list_unnest_2[activity_list_unnest_2$iati_identifier=="GB-COH-03122495-A0014",]
activity_list_unnest_2 <- activity_list_unnest_2_trans %>% select(iati_identifier, recipient_country)
activity_list_unnest_2_country <- partner_activity_comb %>%
#filter(lengths(recipient_country_code) != 0) %>%
unnest(c(recipient_country_code)) %>%
select(iati_identifier, recipient_country_code)
activity_list_unnest_2_country$recipient_country <- countrycode_list$name[match(activity_list_unnest_2_country$recipient_country_code,countrycode_list$code)]
activity_list_unnest_2_country <- activity_list_unnest_2_country %>% select(-recipient_country_code) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(recipient_country = paste(coalesce(recipient_country, ""), collapse = ", "))
activity_list_unnest_2_region <- partner_activity_comb %>%
#filter(lengths(recipient_country_code) != 0) %>%
unnest(c(recipient_region_code)) %>%
select(iati_identifier, recipient_region_code)
activity_list_unnest_2_region$recipient_region <- regioncode_list$name[match(activity_list_unnest_2_region$recipient_region_code,regioncode_list$code)]
activity_list_unnest_2_region <- activity_list_unnest_2_region %>% select(-recipient_region_code) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(recipient_region = paste(coalesce(recipient_region, ""), collapse = ", "))
activity_list_unnest_2 <- full_join(activity_list_unnest_2_country, activity_list_unnest_2_region, by = "iati_identifier")
activity_list_unnest_2$recipient_country_region <- coalesce(activity_list_unnest_2$recipient_country, activity_list_unnest_2$recipient_region)
activity_list_unnest_2 <- activity_list_unnest_2 %>%
mutate(across(c(recipient_country_region), na_if, "Developing countries, unspecified")) %>%
select(-recipient_country, -recipient_region)
activity_list_unnest_2_test <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(transaction_countries_summarised, by = "iati_identifier")
View(activity_list_unnest_2_test)
View(activity_list_unnest_2_test)
activity_list_unnest_2_test <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(transaction_countries_summarised, by = "iati_identifier") %>%
mutate(recipient_country = coalesce(recipient_country_region, recipient_country))
activity_list_unnest_2_test[activity_list_unnest_2_test$iati_identifier=="GB-COH-03122495-A0014",]
# Join on transactions country and org info to relevant datasets
activity_list_unnest_2_test <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(transaction_countries_summarised, by = "iati_identifier") %>%
mutate(recipient_country = coalesce(recipient_country_region, recipient_country)) %>%
select(-recipient_country_region)
activity_list_unnest_2_test[activity_list_unnest_2_test$iati_identifier=="GB-COH-03122495-A0014",]
# Join on transactions country and org info to relevant datasets
activity_list_unnest_2 <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(transaction_countries_summarised, by = "iati_identifier") %>%
mutate(recipient_country = coalesce(recipient_country_region, recipient_country)) %>%
select(-recipient_country_region)
rm(activity_list_unnest_2_test)
View(activity_list_unnest_4)
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7, by = "iati_identifier")
activity_list[activity_list$iati_identifier=="GB-COH-03122495-A0014",]
activity_list_unnest_4_test <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(transaction_orgs_summarised, by = "iati_identifier") %>%
left_join(transaction_org_countries_summarised, by = "iati_identifier")
View(activity_list_unnest_4_test)
rm(activity_list_unnest_4_test)
activity_list_unnest_4 <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(transaction_orgs_summarised, by = "iati_identifier") %>%
left_join(transaction_org_countries_summarised, by = "iati_identifier") %>%
mutate(partner = coalesce(partner, transaction_receiver_org_narrative),
partner_country = coalesce(partner_country, transaction_receiver_country)) %>%
select(-transaction_receiver_org_narrative, -transaction_receiver_country)
activity_list_unnest_4 <- partner_activity_comb %>%
select(iati_identifier) %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(transaction_orgs_summarised, by = "iati_identifier") %>%
left_join(transaction_org_countries_summarised, by = "iati_identifier") %>%
mutate(partner = coalesce(partner, transaction_receiver_org_narrative),
partner_country = coalesce(partner_country, transaction_receiver_country)) %>%
select(-transaction_receiver_org_narrative, -transaction_receiver_country)
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7, by = "iati_identifier")
# Assign a reporting org name if missing
activity_list <- activity_list %>%
mutate(reporting_org = coalesce(reporting_org_narrative, reporting_org_ref, gov_funder))
# Reorder columns and add date of refresh
activity_list <- activity_list %>%
select(iati_identifier, reporting_org_ref, reporting_org, reporting_org_country,
hierarchy, activity_status, activity_id,
activity_title, activity_description, start_date, end_date,
recipient_country, sector_name,
partner, partner_country,
gov_funder, fund,
amount, period_start, period_end, currency) %>%
unique() %>%
mutate(refresh_date = Sys.Date())
activity_list <- activity_list %>%
# Add missing FCDO activity IDs (IDRC and AgResults)
rename(programme_id = activity_id) %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id),
# Add Fund and Funder label
fund = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "FCDO Research - Programmes",
str_detect(programme_id, "GB-GOV-10") ~ "DHSC - Global Health Research - Partnerships",
TRUE ~ fund),
gov_funder = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "Foreign, Commonwealth and Development Office",
str_detect(programme_id, "GB-GOV-10") ~ "Department of Health and Social Care",
TRUE ~ gov_funder)) %>% unique()
activity_list[activity_list$iati_identifier=="GB-COH-03122495-A0014",]
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
activity_list_unnest_3[activity_list_unnest_3$iati_identifier=="GB-COH-03122495-A0014",]
activity_list_unnest_3 <- partner_activity_comb %>%
#filter(lengths(sector_code) != 0) %>%
unnest(cols = sector_code) %>%
select(iati_identifier, sector_code) %>%
unique()
activity_list_unnest_3$sector_name <- sector_list$name[match(activity_list_unnest_3$sector_code,sector_list$code)]
activity_list_unnest_3 <- activity_list_unnest_3 %>% select(-sector_code) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(sector_name = paste(coalesce(sector_name, ""), collapse = ", "))
activity_list_unnest_3[activity_list_unnest_3$iati_identifier=="GB-COH-03122495-A0014",]
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7, by = "iati_identifier")
activity_list <- activity_list %>%
mutate(reporting_org = coalesce(reporting_org_narrative, reporting_org_ref, gov_funder))
# Reorder columns and add date of refresh
activity_list <- activity_list %>%
select(iati_identifier, reporting_org_ref, reporting_org, reporting_org_country,
hierarchy, activity_status, activity_id,
activity_title, activity_description, start_date, end_date,
recipient_country, sector_name,
partner, partner_country,
gov_funder, fund,
amount, period_start, period_end, currency) %>%
unique() %>%
mutate(refresh_date = Sys.Date())
activity_list <- activity_list %>%
# Add missing FCDO activity IDs (IDRC and AgResults)
rename(programme_id = activity_id) %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_description, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
TRUE ~ programme_id),
# Add Fund and Funder label
fund = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "FCDO Research - Programmes",
str_detect(programme_id, "GB-GOV-10") ~ "DHSC - Global Health Research - Partnerships",
TRUE ~ fund),
gov_funder = case_when(
str_detect(programme_id, "GB-GOV-1-|GB-1-") ~ "Foreign, Commonwealth and Development Office",
str_detect(programme_id, "GB-GOV-10") ~ "Department of Health and Social Care",
TRUE ~ gov_funder)) %>% unique()
write.xlsx(activity_list, file = "Outputs/partner_activity_list_kp_v3.xlsx")
